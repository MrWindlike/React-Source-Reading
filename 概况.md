# å‰è¨€
æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸€äº›Reactçš„è®¾è®¡æ€æƒ³å’Œç›¸å…³æ¦‚å¿µï¼Œä¸ç®¡æ˜¯æƒ³è¦é˜…è¯»æºç è¿˜æ˜¯æƒ³æ·±å…¥äº†è§£Reactçš„åŒå­¦çœ‹è¿‡æ¥å‘€ã€‚æ¬¢è¿æŒ‡å‡ºé”™è¯¯ï¼Œä¸€èµ·æ¢è®¨ä¸€èµ·è¿›æ­¥ã€‚

## åŒç³»åˆ—æ–‡ç« 
å› ä¸ºæ¯æ¬¡æ›´æ–°æ–‡ç« éƒ½è¦æ›´æ–°ä¸€éç›®å½•å¤ªéº»çƒ¦ï¼Œæ‰€ä»¥æœ¬ç³»åˆ—çš„æ–‡ç« éƒ½æ•´åˆåˆ°Githubï¼Œæœ‰å…´è¶£é˜…è¯»æ›´å¤šReactæºç é˜…è¯»æ–‡ç« çš„åŒå­¦å¯ä»¥ç”¨åŠ›ç‚¹[è¿™é‡Œè¿™é‡Œè¿™é‡Œ](https://github.com/MrWindlike/React-Source-Reading)ï¼Œå¦‚æœè§‰å¾—æ–‡ç« å†™å¾—è¿˜è¡Œçš„è¯ï¼Œå¯¹ä½ æœ‰å°å°çš„å¸®åŠ©ï¼Œå¸Œæœ›å¯ä»¥ç»™é¢—å°æ˜Ÿæ˜Ÿç»™æˆ‘ï¼Œè°¢è°¢ğŸ˜œ

# é¡¹ç›®ç»“æ„
Reactçš„ç›¸å…³ä»£ç éƒ½æ”¾åœ¨packagesé‡Œã€‚
```
â”œâ”€â”€ packages ------------------------------- Reactå®ç°çš„ç›¸å…³ä»£ç 
â”‚   â”œâ”€â”€ create-subscription ------------------------- åœ¨ç»„ä»¶é‡Œè®¢é˜…é¢å¤–æ•°æ®çš„å·¥å…·
â”‚   â”œâ”€â”€ events -------------------------- Reactäº‹ä»¶ç›¸å…³
â”‚   â”œâ”€â”€ react-art ------------------------- ç”»å›¾ç›¸å…³åº“
â”‚   â”œâ”€â”€ react-dom -------------------------- ReactDom
â”‚   â”œâ”€â”€ react-native-renderer ----------------------------- ReactNative
â”‚   â”œâ”€â”€ react-reconciler ------------------------ Reactè°ƒåˆ¶å™¨
â”‚   â”œâ”€â”€ react-scheduler ------------------------ è§„åˆ’Reactåˆå§‹åŒ–ï¼Œæ›´æ–°ç­‰ç­‰
â”‚   â”œâ”€â”€ react-test-renderer ------------------------ å®éªŒæ€§çš„Reactæ¸²æŸ“å™¨
â”‚   â”œâ”€â”€ shared ------------------------ å…¬å…±ä»£ç 
â”‚   â”œâ”€â”€ simple-cache-provider ------------------------ ä¸ºReactåº”ç”¨æä¾›ç¼“å­˜
```

# ä¸»è¦æ€æƒ³å’Œè®¾è®¡åŸåˆ™

## ç»„åˆ
Reactçš„ä¸»è¦ç‰¹æ€§å°±æ˜¯å„ç§ç»„åˆè€Œæˆçš„ç»„ä»¶ã€‚ç”±ä¸åŒäººç¼–å†™çš„ç»„ä»¶å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œå¹¶ä¸”å®ç°ç»„ä»¶çš„å¤ç”¨ã€‚

## æ—¶åºå®‰æ’(Scheduling)
Reactçš„åˆå§‹åŒ–ï¼Œæ›´æ–°ï¼Œç§»é™¤ç­‰ç­‰æ“ä½œå¹¶ä¸æ˜¯åŒæ­¥çš„ï¼Œç”¨æˆ·ç¼–å†™çš„ç»„ä»¶(å¦‚```<ReactComponent/>```)æˆ–è€…å¹³å°ç‰¹å®šç»„ä»¶(å¦‚```<div/>```)è¿™äº›åªæ˜¯è¿”å›éœ€è¦æ¸²æŸ“çš„ä¿¡æ¯ï¼Œå¹¶ä¸æ˜¯çœŸå®DOMï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä»–ä»¬ä¸ºè™šæ‹ŸDOMï¼ŒReactä¼šéå†è¿™é¢—è™šæ‹ŸDOMæ ‘æ¥æ¸²æŸ“çœŸå®çš„DOMæ ‘ã€‚

è€Œä¸”```setState()```ä¹Ÿå¹¶ä¸æ˜¯åŒæ­¥çš„ï¼Œä»–ä»¬çš„å¤šæ¬¡è°ƒç”¨æ›´æ–°ä¼šè¢«æ•´åˆä¸ºä¸€æ¬¡æ›´æ–°ï¼ŒåŠ å…¥æ›´æ–°é˜Ÿåˆ—ç„¶åç­‰å¾…æ›´æ–°ï¼Œå†å»æ¸²æŸ“çœŸå®çš„DOMæ ‘ï¼Œå› ä¸ºDOMå‹çš„æ“ä½œé€šå¸¸æ˜¯å¾ˆè€—æ—¶çš„ï¼Œæ‰€ä»¥å°½é‡å‡å°‘DOMç›¸å…³æ“ä½œã€‚

## DOMä¹‹å¤–
Reactçš„ä¸€ä¸ªä¸»è¦ç‰¹ç‚¹ä¸ºç¼–å†™çš„ä»£ç å¯ä»¥é€šè¿‡å·¥å…·(å¦‚ReactNativeï¼ŒElectron)åœ¨å¤šä¸ªå¹³å°ä¸Šè¿è¡Œï¼Œå› æ­¤æ¸²æŸ“å‡ºæ¥çš„å…ƒç´ å¯èƒ½ä¸æ˜¯DOMï¼Œå› æ­¤Reactå°†ä»–ä»¬åˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼Œä¸€ä¸ªæ¨¡å—ä¸ºreconciler(è°ƒèŠ‚å™¨)ï¼Œå®ƒæ ¹æ®ç”¨æˆ·ç¼–å†™çš„ç»„ä»¶è½¬æ¢ä¸ºReactå¯ä»¥è¯†åˆ«çš„å…ƒç´ (å³è™šæ‹ŸDOM)ï¼›å¦ä¸€ä¸ªæ¨¡å—ä¸ºrenderer(æ¸²æŸ“å™¨ï¼Œåˆ†ä¸ºDOMæ¸²æŸ“å™¨å’ŒNativeæ¸²æŸ“å™¨)ï¼Œå®ƒçš„ä½œç”¨ä¸ºæ ¹æ®è™šæ‹ŸDOMæ¸²æŸ“ä¸ºå¹³å°ç‰¹å®šçš„å…ƒç´ ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥æ–¹ä¾¿Reactå¯ä»¥åœ¨å¤šå¹³å°ä¸Šè¿è¡Œï¼Œè€Œä¸å¿…å¤ªè¿‡å…³æ³¨reconcilerçš„ä»£ç ã€‚

# ç›¸å…³æ¦‚å¿µ

## Fiber

### ä»€ä¹ˆæ˜¯Fiberï¼Ÿ

Fiberæ˜¯Reactç‰ˆæœ¬16ä»¥åçš„é‡è¦æ¦‚å¿µã€‚

Fiberçš„ä¸»è¦ç›®æ ‡ä¸ºï¼š
- å…ˆæš‚åœç›®å‰çš„å·¥ä½œå»å¤„ç†ä¼˜å…ˆçº§æ›´é«˜çš„å·¥ä½œï¼Œç„¶åå†å›æ¥ç»§ç»­
- ä¸ºä¸åŒçš„å·¥ä½œè®¾å®šä¸åŒä¼˜å…ˆçº§
- é‡ç”¨ä¹‹å‰å®Œæˆçš„å·¥ä½œ
- ç»ˆæ­¢ä¸å†éœ€è¦çš„å·¥ä½œ

æˆ‘ä»¬éƒ½çŸ¥é“è°ƒç”¨å‡½æ•°æ—¶ä¼šæŠŠå®ƒåŠ å…¥æ‰§è¡Œæ ˆä¸­ï¼Œç­‰å‡½æ•°æ‰§è¡Œå®Œåå†é€€å‡ºæ ˆï¼Œé‚£æœ‰æ²¡æœ‰åŠæ³•å¯ä»¥å®šåˆ¶æ ˆçš„è°ƒç”¨ä»¥æ›´å¥½åœ°ä¼˜åŒ–æ¸²æŸ“UIå‘¢ï¼Ÿè¿™å°±æ˜¯Fiberæƒ³è¦è§£å†³çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç§°å•ä¸ªFiberä¸ºè™šæ‹Ÿçš„æ ˆå¸§ï¼Œå®ƒæ˜¯å®ç°Reactæ—¶åºå®‰æ’çš„å…³é”®ã€‚

### Fiberçš„ç»“æ„
```js
type Fiber = {|
  //  è¾¨è¯†ç»„ä»¶ç›¸å…³çš„å±æ€§
  tag: TypeOfWork,
  key: null | string,
  type: any,
  
  //  çˆ¶Fiberæˆ–è€…null
  return: Fiber | null,

  child: Fiber | null,
  sibling: Fiber | null,
  index: number,
  ref: null | (((handle: mixed) => void) & {_stringRef: ?string}) | RefObject,

  memoizedProps: any, // The props used to create the output.
  updateQueue: UpdateQueue<any> | null,
  memoizedState: any,
  
  mode: TypeOfMode,

  effectTag: TypeOfSideEffect,
  nextEffect: Fiber | null,
  firstEffect: Fiber | null,
  lastEffect: Fiber | null,
  
  expirationTime: ExpirationTime,

  alternate: Fiber | null,

  //  æ—¶é—´
  actualDuration?: number,
  actualStartTime?: number,
  selfBaseTime?: number,
  treeBaseTime?: number,

 //  è°ƒè¯•
  _debugID?: number,
  _debugSource?: Source | null,
  _debugOwner?: Fiber | null,
  _debugIsCurrentlyTiming?: boolean,
|};
```

#### ```key```ã€```type```
è¿™ä¸¤ä¸ªå±æ€§éƒ½æ˜¯ç”¨æ¥è¡¨ç¤ºç»„ä»¶çš„ï¼Œæ›´æ–°ç»„ä»¶çš„æ—¶å€™å…ˆæ£€æŸ¥```key```æ˜¯å¦æœ‰æ”¹å˜ï¼Œå¦‚æœæ”¹å˜çš„è¯åˆ™ç›´æ¥æ‘§æ¯é‡å»ºï¼›ä¸å˜çš„è¯åˆ™ç»§ç»­æ£€æŸ¥```type```æ˜¯å¦æ”¹å˜ï¼Œæ”¹å˜åˆ™ç›´æ¥æ‘§æ¯é‡å»ºï¼›å¦åˆ™é‡ç”¨åŸæ¥çš„ç»„ä»¶ï¼Œåªæ˜¯æ”¹å˜ç»„ä»¶çš„å±æ€§ã€‚```type```å¯èƒ½æ˜¯ç”¨æˆ·å®šä¹‰çš„å‡½æ•°å‹æˆ–è€…ç±»å‹çš„ç»„åˆå‹ç»„ä»¶ï¼Œæˆ–è€…æ˜¯ä»£è¡¨å¹³å°å…ƒç´ çš„å­—ç¬¦ä¸²(å¦‚```'div'```)ã€‚

### ```pendingProps```ã€```memoizedProps```
æ¦‚å¿µä¸Šæ¥è¯´ï¼Œ```props```å°±æ˜¯ä¸€ä¸ªå‡½æ•°çš„å‚æ•°æ•°ç»„ã€‚```pendingProps```æ˜¯Fiberå¼€å§‹æ‰§è¡Œçš„æ—¶å€™è¢«è®¾å®šçš„ï¼Œ```memoizedProps```åœ¨æ‰§è¡Œå®Œä¹‹åã€‚æ¯æ¬¡æ›´æ–°çš„æ—¶å€™å…ˆæ¯”è¾ƒ```pendingProps```å’Œ```memoizedProps```ï¼Œå¦‚æœå®ƒä»¬ç›¸åŒï¼Œåˆ™è¡¨ç¤ºå…ˆå‰çš„è¾“å‡ºå¯ä»¥é‡ç”¨ï¼Œè€Œä¸å¿…è¿›è¡Œå¤šä½™çš„å·¥ä½œã€‚

### ```pendingWorkPriority```
ä¸€ä¸ªè¡¨é¢å·¥ä½œä¼˜å…ˆæƒçš„å±æ€§ã€‚é™¤```NoWork```(å®ƒçš„å€¼ä¸º0)ä»¥å¤–ï¼Œæ•°å€¼è¶Šå¤§ä»£è¡¨æœ‰é™æƒè¶Šä½ã€‚
```js
function matchesPriority(fiber, priority) {
  return fiber.pendingWorkPriority !== 0 &&
         fiber.pendingWorkPriority <= priority
}
```


# å‚è€ƒæ–‡çŒ®
- [React Fiber Architecture](https://github.com/acdlite/react-fiber-architecture)
- [Codebase Overview](https://reactjs.org/docs/codebase-overview.html)
- [Design Principles](https://reactjs.org/docs/design-principles.html)